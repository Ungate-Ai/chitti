version: v1.0
name: Build and Deploy Application
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

global_job_config:
  secrets:
    - name: DO_KUBE_CONFIG
    - name: ENV_FILE
    - name: DO_UNGATE_CR
  env_vars:
    - name: KUBECONFIG
      value: /home/semaphore/kube8.yaml

blocks:
  - name: Pull and Build Block
    dependencies: []
    task:
      jobs:
        - name: Build Docker Image
          commands:
            - checkout
            - echo "$ENV_FILE" > .env
            - docker login registry.digitalocean.com -u "$DOCKER_USERNAME" -p "$DOCR_TOKEN"
            - docker build -t chitti-image:latest .
            - docker tag chitti-image:latest registry.digitalocean.com/ungate/chitti:development
            - docker push registry.digitalocean.com/ungate/chitti:development

  - name: Deploy Block
    dependencies:
      - Pull and Build Block
    task:
      jobs:
        - name: Deploy to Kubernetes
          commands:
            - checkout
            - mkdir -p /home/semaphore/.kube
            - export KUBECONFIG=/home/semaphore/kube8.yaml
            - echo "$KUBECONFIG"
            - echo "$DOCR_TOKEN"
            - echo "$DOCKER_USERNAME"
            - kubectl config get-contexts --v=8
            - kubectl config use-context do-blr1-k8s-ungate-init --v=8
            - |
              if ! kubectl get secret docker-secret; then
                kubectl create secret docker-registry docker-secret \
                  --docker-server=registry.digitalocean.com \
                  --docker-username="$DOCKER_USERNAME" \
                  --docker-password="$DOCR_TOKEN" \
                  --docker-email="$DOCKER_USERNAME"
              else
                echo "Docker secret 'docker-secret' already exists. Skipping creation."
              fi
            - kubectl apply -f k8s/deployment.yaml
            - kubectl apply -f k8s/service.yaml
